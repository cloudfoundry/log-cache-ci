#!/bin/bash

set -exu

function set_globals {
    pipeline=$1
    pipeline_ext='.yml'
    pipeline_dir='pipelines/'
    config_path=${pipeline_dir}${pipeline}${pipeline_ext}
    TARGET="${TARGET:-log-cache}"
}

function validate_usage {
    if [ "$pipeline" = "-h" ] || [ "$pipeline" = "--help" ] || [ -z "$pipeline" ]; then
        print_usage
        exit 1
    fi
}

function validate_pipeline {
    echo -n "Validating '${pipeline}' pipeline ... "

    fly -t ${TARGET} validate-pipeline \
      --config=${config_path} \
      --load-vars-from=pipelines/shared-config.yml
}

function sync_fly {
    fly -t $TARGET sync
}

function reconfigure_pipeline {
    echo "Reconfiguring '${pipeline}' pipeline ..."

    reconfigure-pipeline \
      --target ${TARGET} \
      --pipeline ${pipeline} \
      --config ${config_path} \
      --load-vars-from pipelines/shared-config.yml
}

function print_usage {
    echo "usage: $0 <pipeline>"
}

function main {
    set_globals $1
    validate_usage
    validate_pipeline
    sync_fly

    if [ $? -eq 0 ]; then
        reconfigure_pipeline
    fi
}

main $1
