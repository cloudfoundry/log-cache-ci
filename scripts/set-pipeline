#!/bin/bash

set -e

function check_lpass {
    echo -n "Checking lpass ... "
    lpass status
}

function set_globals {
    pipeline=$1
    pipeline_ext='.yml'
    pipeline_dir='pipelines/'

    if [[ "${pipeline}" == prod/* ]] || [[ "${pipeline}" == edge/* ]]; then
        pipeline="pws/${pipeline}"
    fi

    if [[ "${pipeline}" == blackbox* ]] || [[ "${pipeline}" == edge* ]]; then
        pipeline="pws/edge/${pipeline}"
    fi

    config_path=${pipeline_dir}${pipeline}${pipeline_ext}

    if [[ "$pipeline" == pws* ]]; then
        TARGET="${TARGET:-pws}"
        pipeline_name=$(echo "${pipeline}" | sed 's/\//-/g')
    else
        TARGET="${TARGET:-log-cache}"
        pipeline_name=${pipeline}
    fi
}

function validate_usage {
    if [ "$pipeline" = "-h" ] || [ "$pipeline" = "--help" ] || [ -z "$pipeline" ]; then
        print_usage
        exit 1
    fi
}

function validate_pipeline {
    echo -n "Validating '${pipeline}' pipeline ... "

    fly -t ${TARGET} validate-pipeline -c ${config_path}
    pipeline_valid=$?

    return $pipeline_valid
}

function sync_fly {
    fly -t $TARGET sync
}

function reconfigure_pipeline {
    echo "Reconfiguring '${pipeline_name}' pipeline ..."

    reconfigure-pipeline \
      --target ${TARGET} \
      --pipeline ${pipeline_name} \
      --config ${config_path}
}

function print_usage {
    echo "usage: $0 <pipeline>"
}

function main {
    check_lpass
    set_globals $1
    validate_usage
    sync_fly
    validate_pipeline

    if [ $? -eq 0 ]; then
        reconfigure_pipeline
    fi
}

main $1
